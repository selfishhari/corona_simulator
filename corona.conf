
<VirtualHost *:80>
    ServerName corona-predictor.hopto.org
    RewriteEngine on
    RewriteCond %{SERVER_NAME} =corona-predictor.hopto.org
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName corona-predictor.hopto.org
    ProxyRequests off
    RewriteEngine On
    #RewriteCond %{HTTP:Connection} Upgrade [NC]
    #RewriteCond %{HTTP:Upgrade} websocket [NC]
    #RewriteRule .* "ws://localhost:${DOCKER_PORT}%{REQUEST_URL}" [P]

    #RewriteCond %{HTTP:Upgrade} !=websocket
    #RewriteRule /(.*) http://localhost:${DOCKER_PORT}/$1 [P]

    Header add Set-Cookie "ROUTEPATH=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED

    <Proxy balancer://http>
        BalancerMember http:/localhost:8501 route=1
        BalancerMember http:/localhost:8502 route=2
        ProxySet stickysession=ROUTEPATH
    </Proxy>

    <Proxy balancer://ws>
        BalancerMember ws:/localhost:8501 route=1
        BalancerMember ws:/localhost:8502 route=2
        ProxySet stickysession=ROUTEPATH
    </Proxy>

    ProxyPass /stream balancer://ws/stream
    ProxyPassReverse /stream balancer://ws/stream

    ProxyPass / balancer://http/
    # set headers
    RequestHeader set X-Forwarded-Port %{SERVER_PORT}e
    RequestHeader set X-Forwarded-Scheme https
    RequestHeader set X_TRUE_IP "%{REMOTE_ADDR}s"

    SSLCertificateFile /etc/letsencrypt/live/corona-predictor.hopto.org/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/corona-predictor.hopto.org/privkey.pem

</VirtualHost>
